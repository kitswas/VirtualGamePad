name: Auto Translate Markdown

on:
  push:
    branches: [main]
    paths:
      - "en/**"
      - ".github/workflows/translate.*"
      - ".github/prompts/*.txt"
  pull_request:
    branches: [main]
    paths:
      - "en/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  models: read

jobs:
  discover:
    name: Discover Markdown Files
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.find.outputs.files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find English markdown files under en/
        id: find
        shell: bash
        run: |
          shopt -s nullglob
          # Find all Markdown files recursively in en/
          mapfile -d '' files < <(find "en" -type f -name "*.md" -print0 | sort -z)
          if [ ${#files[@]} -eq 0 ]; then
            echo "files=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Build JSON array, e.g. ["en/README.md","en/FAQ.md",...]
          json="["
          sep=""
          for f in "${files[@]}"; do
            # strip trailing nulls
            f="${f%\0}"
            json+="$sep\"$f\""
            sep="," 
          done
          json+="]"
          echo "files=$json" >> "$GITHUB_OUTPUT"

  translate-and-pr:
    name: Translate files and create PRs
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        source: [en]
        target: [bn, hi, te]
        file: ${{ fromJson(needs.discover.outputs.files) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute target file path
        id: paths
        run: |
          source_file="${{ matrix.file }}"
          # Extract relative path from en/
          rel_path="${source_file#en/}"
          target_file="${{ matrix.target }}/${rel_path}"
          echo "rel_path=${rel_path}" >> "$GITHUB_OUTPUT"
          echo "target_file=${target_file}" >> "$GITHUB_OUTPUT"

      - name: Map language code to full name
        id: lang_map
        run: |
          case "${{ matrix.target }}" in
            bn) echo "lang_name=Bengali" >> "$GITHUB_OUTPUT" ;;
            hi) echo "lang_name=Hindi" >> "$GITHUB_OUTPUT" ;;
            te) echo "lang_name=Telugu" >> "$GITHUB_OUTPUT" ;;
            *) echo "lang_name=${{ matrix.target }}" >> "$GITHUB_OUTPUT" ;;
          esac

      # Add random delay to reduce rate limiting issues
      - name: Random delay
        run: |
          delay=$(( RANDOM % 20 + 1 ))
          echo "Delaying for $delay seconds to avoid rate limiting..."
          sleep $delay

      - name: Translate using AI
        id: translate
        uses: actions/ai-inference@v2
        with:
          enable-github-mcp: true
          prompt-file: .github/prompts/translate.txt
          system-prompt-file: .github/prompts/system-prompt.txt
          input: |
            target_lang: ${{ steps.lang_map.outputs.lang_name }}
            source_file: ${{ matrix.file }}
          # The AI Inference action requires a token for inference (GITHUB_TOKEN is fine)
          # and a Personal Access Token (PAT) to access the GitHub MCP server.
          # Create a repository secret named `USER_PAT` with a PAT that has repo access,
          # then the action will pass it to the MCP server via `github-mcp-token`.
          token: ${{ secrets.GITHUB_TOKEN }}
          github-mcp-token: ${{ secrets.USER_PAT }}
          model: openai/gpt-4o
          max-tokens: 64000

      - name: Create target directory
        run: |
          mkdir -p "$(dirname "${{ steps.paths.outputs.target_file }}")"

      - name: Write translated file
        run: |
          cat > "${{ steps.paths.outputs.target_file }}" << 'EOF'
          ${{ steps.translate.outputs.response }}
          EOF

      - name: Create pull request with translated files
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "Auto-translate markdown: ${{ steps.paths.outputs.rel_path }} (en -> ${{ matrix.target }})"
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          branch: "auto-translate/en-to-${{ matrix.target }}-${{ github.run_number }}"
          title: "Auto-translate: ${{ steps.paths.outputs.rel_path }} â†’ ${{ matrix.target }}"
          body: |
            This PR contains an auto-translated markdown file from ${{ matrix.source }} to ${{ matrix.target }}.

            **File:** `${{ steps.paths.outputs.target_file }}`
            **Original:** `${{ matrix.file }}`

            Translation performed by AI Inference (OpenAI GPT-4O)
          labels: translation, automation
          add-paths: ${{ steps.paths.outputs.target_file }}
