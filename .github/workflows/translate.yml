name: Auto Translate Markdown

on:
  push:
    branches: [main]
    paths:
      - "en/**"
      - ".github/workflows/translate.*"
      - ".github/prompts/*.txt"
  pull_request:
    branches: [main]
    paths:
      - "en/**"
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  discover:
    name: Discover Markdown Files
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.find.outputs.files }}
      is_source_change: ${{ steps.detect_trigger.outputs.is_source_change }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect trigger source
        id: detect_trigger
        run: |
          # For push events, check if any changed files are in en/
          if [ "${{ github.event_name }}" = "push" ]; then
            # Get changed files - only check en/** for source changes
            changed_files="${{ github.event.before }}..${{ github.event.after }}"
            files_in_en=$(git diff $changed_files --name-only | grep "^en/" || true)
            
            if [ -n "$files_in_en" ]; then
              echo "is_source_change=true" >> "$GITHUB_OUTPUT"
            else
              echo "is_source_change=false" >> "$GITHUB_OUTPUT"
            fi
          else
            # For pull_request and workflow_dispatch, assume it's a source change
            echo "is_source_change=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Find changed English markdown files (source change)
        id: find_changed
        if: steps.detect_trigger.outputs.is_source_change == 'true'
        shell: bash
        run: |
          shopt -s nullglob
          
          # Get list of changed files in en/
          if [ "${{ github.event_name }}" = "push" ]; then
            changed_files=$(git diff ${{ github.event.before }}..${{ github.event.after }} --name-only | grep "^en/.*\.md$" || true)
          else
            # For pull_request and workflow_dispatch, get all files
            changed_files=$(find "en" -type f -name "*.md" | sort)
          fi
          
          if [ -z "$changed_files" ]; then
            echo "files=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Build JSON array
          json="["
          sep=""
          while IFS= read -r f; do
            json+="$sep\"$f\""
            sep=","
          done <<< "$changed_files"
          json+="]"
          echo "files=$json" >> "$GITHUB_OUTPUT"

      - name: Find all Source markdown files (non-source change)
        id: find_all
        if: steps.detect_trigger.outputs.is_source_change == 'false'
        shell: bash
        run: |
          shopt -s nullglob
          # Find all Markdown files recursively in en/
          mapfile -d '' files < <(find "en" -type f -name "*.md" -print0 | sort -z)
          if [ ${#files[@]} -eq 0 ]; then
            echo "files=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Build JSON array
          json="["
          sep=""
          for f in "${files[@]}"; do
            # strip trailing nulls
            f="${f%\0}"
            json+="$sep\"$f\""
            sep="," 
          done
          json+="]"
          echo "files=$json" >> "$GITHUB_OUTPUT"

      - name: Determine final file list
        id: find
        run: |
          if [ "${{ steps.detect_trigger.outputs.is_source_change }}" = "true" ]; then
            files='${{ steps.find_changed.outputs.files }}'
          else
            files='${{ steps.find_all.outputs.files }}'
          fi
          echo "files=$files" >> "$GITHUB_OUTPUT"

  create-translation-issues:
    name: Create translation issues per language
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [bn, hi, te]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Map language code to full name
        id: lang_map
        run: |
          case "${{ matrix.target }}" in
            bn) echo "lang_name=Bengali" >> "$GITHUB_OUTPUT" ;;
            hi) echo "lang_name=Hindi" >> "$GITHUB_OUTPUT" ;;
            te) echo "lang_name=Telugu" >> "$GITHUB_OUTPUT" ;;
            *) echo "lang_name=${{ matrix.target }}" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Build file mappings and issue body
        id: build_body
        run: |
          files='${{ needs.discover.outputs.files }}'
          target="${{ matrix.target }}"
          is_source_change='${{ needs.discover.outputs.is_source_change }}'
          
          # Start building the issue body
          body="Using the system prompt from .github/prompts/system-prompt.txt as your translation guidelines:"
          body+=$'\n\n'
          
          if [ "$is_source_change" = "true" ]; then
            body+="Translate the following **changed** files into ${{ steps.lang_map.outputs.lang_name }}:"
          else
            body+="Retranslate all files in en/** into ${{ steps.lang_map.outputs.lang_name }}."
          fi
          
          body+=$'\n\n'
          
          # Parse the JSON array and build the file list
          while IFS= read -r source_file; do
            # Extract relative path from en/
            rel_path="${source_file#en/}"
            target_file="${target}/${rel_path}"
            
            body+="- Source: \`${source_file}\`"
            body+=$'\n'
            body+="  Target: \`${target_file}\`"
            body+=$'\n'
          done < <(echo "$files" | jq -r '.[]')
          
          # Escape newlines for GitHub output
          body_escaped=$(printf '%s' "$body" | jq -Rs .)
          echo "body=$body_escaped" >> "$GITHUB_OUTPUT"

      - name: Create translation issue
        id: create_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ '${{ needs.discover.outputs.is_source_change }}' = "true" ]; then
            issue_title="Translate changed files to ${{ steps.lang_map.outputs.lang_name }}"
          else
            issue_title="Retranslate all files to ${{ steps.lang_map.outputs.lang_name }}"
          fi
          
          issue_body=$(echo '${{ steps.build_body.outputs.body }}' | jq -r .)
          
          # Create the issue without assignee
          issue_url=$(gh issue create \
            --title "$issue_title" \
            --body "$issue_body" \
            --label "translation")
          
          # Extract issue number from URL (e.g., https://github.com/owner/repo/issues/123)
          issue_number=$(echo "$issue_url" | grep -oE '[0-9]+$')
          
          echo "Created translation issue: $issue_title (Issue #$issue_number)"
          echo "issue_url=$issue_url" >> "$GITHUB_OUTPUT"
          echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"

      - name: Assign Copilot to issue
        env:
          GH_TOKEN: ${{ secrets.Copilot_Billing_Target }}
        run: |
          gh issue edit ${{ steps.create_issue.outputs.issue_number }} \
            --add-assignee "@copilot"
          
          echo "Assigned @copilot to issue #${{ steps.create_issue.outputs.issue_number }}"
