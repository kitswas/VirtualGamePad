name: Auto Translate Markdown

on:
  push:
    branches: [main]
    paths:
      - "en/**"
      - ".github/workflows/translate.*"
  pull_request:
    branches: [main]
    paths:
      - "en/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  discover:
    name: Discover Markdown Files
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.find.outputs.files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find English markdown files under en/
        id: find
        shell: bash
        run: |
          shopt -s nullglob
          # Find all Markdown files recursively in en/
          mapfile -d '' files < <(find "en" -type f -name "*.md" -print0 | sort -z)
          if [ ${#files[@]} -eq 0 ]; then
            echo "files=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Build JSON array, e.g. ["en/README.md","en/FAQ.md",...]
          json="["
          sep=""
          for f in "${files[@]}"; do
            # strip trailing nulls
            f="${f%\0}"
            json+="$sep\"$f\""
            sep="," 
          done
          json+="]"
          echo "files=$json" >> "$GITHUB_OUTPUT"

  translate-and-pr:
    name: Translate files and create PRs
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        source: [en]
        target: [bn, hi, te]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: pip install translators python-frontmatter markdown-it-py mdformat

      - name: Translate all files to ${{ matrix.target }}
        shell: bash
        env:
          FILES: ${{ needs.discover.outputs.files }}
        run: |
          set -eo pipefail
          files=$(echo "$FILES" | jq -r '.[]')
          for file in $files; do
            # Compute relative path from en/
            rel="$file"
            case "$rel" in en/*) rel="${rel#en/}" ;; esac
            # Create target directory
            mkdir -p "${{ matrix.target }}/$(dirname "$rel")"
            # Translate using Python script
            python3 .github/workflows/translate.py \
              --source-file $file \
              --target-file ${{ matrix.target }}/$rel \
              --source-lang ${{ matrix.source }} \
              --target-lang ${{ matrix.target }} \
              --translator google
          done

      - name: Create pull request with translated files
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "Auto-translate markdown files (en -> ${{ matrix.target }})"
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          branch: "auto-translate/en-to-${{ matrix.target }}"
          title: "Auto-translate markdown files (en -> ${{ matrix.target }})"
          body: |
            This PR contains auto-translated markdown files from English to ${{ matrix.target }}.
          labels: translation, automation
          add-paths: ${{ matrix.target }}/**
